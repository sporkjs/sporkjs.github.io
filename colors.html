<!doctype html>
<html>
<head>
<style>
#spork{
	position:fixed;
	top:10px;
	bottom:10px;
	left:10px;
	right:10px;
}
</style>
<script src='spork.js'></script>
<script>
//tetracolors

function applyMatrix(M,v){
  var t=[];
  var i,j;
  for (i=0;i<v.length;i++)
    t[i]=0;
  for (i=0;i<v.length;i++)
    for (j=0;j<v.length;j++)
      t[i]+=M[i][j]*v[j];
  for (i=0;i<v.length;i++)
    v[i]=t[i];
}

function tetraColors(X){
  var i;
  
  //Set up base tetrahedron
  var l=1/sqrt(3);
  var x1=[l,l,l];
  var x2=[-l,-l,l];
  var x3=[-l,l,-l];
  var x4=[l,-l,-l]; 
  //Rotate tetrahedron
  var a=random()*2*pi;
  var b=0;//random()*2*pi;
  var c=random()*2*pi;
  var Rx=[[1,0,0],
         [0,cos(a),-sin(a)],
         [0,sin(a),cos(a)]];
  
  var Ry=[[cos(b),0,sin(b)],
         [0,1,0],
         [-sin(b),0,cos(b)]];
  
  var Rz=[[cos(c),-sin(c),0],
         [sin(c),cos(c),0],
         [0,0,1]];
  applyMatrix(Rx,x1);applyMatrix(Ry,x1);applyMatrix(Rz,x1);
  applyMatrix(Rx,x2);applyMatrix(Ry,x2);applyMatrix(Rz,x2);
  applyMatrix(Rx,x3);applyMatrix(Ry,x3);applyMatrix(Rz,x3);
  applyMatrix(Rx,x4);applyMatrix(Ry,x4);applyMatrix(Rz,x4); 
  //Convert coordinates to RGB values
  for (i=0;i<3;i++){
    x1[i]=floor(128*x1[i]+128);
    x2[i]=floor(128*x2[i]+128);
    x3[i]=floor(128*x3[i]+128);
    x4[i]=floor(128*x4[i]+128);
  }
  
  //Copy colors to return matrix
  X[X.length]=rgb(x1[0],x1[1],x1[2]);
  X[X.length]=rgb(x2[0],x2[1],x2[2]);
  X[X.length]=rgb(x3[0],x3[1],x3[2]);
  X[X.length]=rgb(x4[0],x4[1],x4[2]);
}


//zipf stuff
function invSum(n){
  var c=0;
  var i;
  for (i=1;i<=n;i++)
    c+=1/i;
  return(c);
}
function zipfIndex(n){
  var z=1/invSum(n);
  var r=random();
  var i=1;
  while (z*invSum(i)<r) i++;
  return(i-1);
}
function zipf(TC){
  return(TC[zipfIndex(TC.length)]);
}

theColors=[];

var tol=100;
var TOL=2*tol;


 

    
function randomNearHalf(){
	return(0.3+random()*0.2);
}
function monSplit(x1,y1,x2,y2,x3,y3,x4,y4){
	var dx1=abs(x2-x1);
	var dy1=abs(y2-y1);
	var dx2=abs(x3-x2);
	var dy2=abs(y3-y2);
	var dx3=abs(x4-x3);
	var dy3=abs(y4-y3);
	var dx4=abs(x1-x4);
	var dy4=abs(y1-y4);
	var d1=sqrt(dx1*dx1+dy1*dy1)+sqrt(dx3*dx3+dy3*dy3);
	var d2=sqrt(dx2*dx2+dy2*dy2)+sqrt(dx4*dx4+dy4*dy4);
	
	var a,b,m1x,m1y,m2x,m2y;
	if ((d1<tol)&&(d2<tol)||(random()<0.00)){
		//rect is small
		quad(x1,y1,x2,y2,x3,y3,x4,y4);
		//fillcolor(floor(random()*256),floor(random()*256),floor(random()*256) );
		fillcolor(zipf(theColors));
		fill();
		//line(x1,y1,x3,y3);line(x2,y2,x4,y4);
/*		color('white');
		beginPath();
		moveTo((x1+x2)/2,(y1+y2)/2);
		theCanvas.quadraticCurveTo(x2,y2,(x2+x3)/2,(y2+y3)/2);
		theCanvas.quadraticCurveTo(x3,y3,(x3+x4)/2,(y3+y4)/2);
		theCanvas.quadraticCurveTo(x4,y4,(x4+x1)/2,(y4+y1)/2);
		theCanvas.quadraticCurveTo(x1,y1,(x1+x2)/2,(y1+y2)/2);
		stroke();
		fill();
*/
/*
	if (random()<0.5)
		line((x1+x2)/2,(y1+y2)/2,(x3+x4)/2,(y3+y4)/2);
	else
		line((x2+x3)/2,(y2+y3)/2,(x4+x1)/2,(y4+y1)/2);
*/	}
	else{
		if (d1>d2){
			a=randomNearHalf();
			m1x=a*x1+(1-a)*x2;
			m1y=a*y1+(1-a)*y2;
			a=randomNearHalf();
			m2x=a*x3+(1-a)*x4;
			m2y=a*y3+(1-a)*y4;
			monSplit(x1,y1,m1x,m1y,m2x,m2y,x4,y4);
			monSplit(m1x,m1y,x2,y2,x3,y3,m2x,m2y);		
		}
		else{
			a=randomNearHalf();
			m1x=a*x2+(1-a)*x3;
			m1y=a*y2+(1-a)*y3;
			a=randomNearHalf();
			m2x=a*x4+(1-a)*x1;
			m2y=a*y4+(1-a)*y1;
			monSplit(x1,y1,x2,y2,m1x,m1y,m2x,m2y);
			monSplit(m2x,m2y,m1x,m1y,x3,y3,x4,y4);		
		}
	}
}
function setup(){
fillContainer();
background('black');
theColors=[];
		tetraColors(theColors);
		linewidth(10);
		ellipse(width/2, height/2, width/2, height/2);
		clip();
	monSplit(0,0,width,0,width,height,0,height);

}

function draw(){

}
</script>
</head>
<body>
<div id='spork'></div>
</body>
</html>